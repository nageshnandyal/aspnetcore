// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.

using System.Collections.Concurrent;
using System.IO.Pipelines;
using System.Text.Json.Nodes;
using Microsoft.AspNetCore.Http;
using Microsoft.OpenApi.Models;

namespace Microsoft.AspNetCore.OpenApi;

/// <summary>
/// Stores schemas generated by the JsonSchemaMapper for a
/// given OpenAPI document for later resolution.
/// </summary>
internal sealed class OpenApiSchemaStore
{
    private readonly ConcurrentDictionary<OpenApiSchemaKey, JsonObject> _schemas = new()
    {
        // Pre-populate OpenAPI schemas for well-defined types in ASP.NET Core.
        [new OpenApiSchemaKey(typeof(IFormFile), null)] = new JsonObject { ["type"] = "string", ["format"] = "binary" },
        [new OpenApiSchemaKey(typeof(IFormFileCollection), null)] = new JsonObject
        {
            ["type"] = "array",
            ["items"] = new JsonObject { ["type"] = "string", ["format"] = "binary" }
        },
        [new OpenApiSchemaKey(typeof(Stream), null)] = new JsonObject { ["type"] = "string", ["format"] = "binary" },
        [new OpenApiSchemaKey(typeof(PipeReader), null)] = new JsonObject { ["type"] = "string", ["format"] = "binary" },
    };

    private readonly ConcurrentDictionary<OpenApiSchema, string?> _schemasWithReference = new(OpenApiSchemaComparer.Instance);

    /// <summary>
    /// Resolves the JSON schema for the given type and parameter description.
    /// </summary>
    /// <param name="key">The key associated with the generated schema.</param>
    /// <param name="valueFactory">A function used to generated the JSON object representing the schema.</param>
    /// <returns>A <see cref="JsonObject" /> representing the JSON schema associated with the key.</returns>
    public JsonObject GetOrAdd(OpenApiSchemaKey key, Func<OpenApiSchemaKey, JsonObject> valueFactory)
    {
        return _schemas.GetOrAdd(key, valueFactory);
    }

    /// <summary>
    /// Add the provided schema to the schema-with-references cache that is eventually
    /// used to populate the top-level components.schemas object. This method will
    /// unwrap the provided schema and add any child schemas to the global cache. Child
    /// schemas include those referenced in the schema.Items, schema.AdditionalProperties, or
    /// schema.Properties collections. A unique identifier is generated for each schema
    /// on the update step to avoid populating the cache with schemas that only appear once in
    /// the document.
    /// </summary>
    /// <param name="schema">The <see cref="OpenApiSchema"/> to add to the schemas-with-references cache.</param>
    public void PopulateSchemaIntoReferenceCache(OpenApiSchema schema)
    {
        _schemasWithReference.AddOrUpdate(schema, (_) => null, (_, _) => Guid.NewGuid().ToString());
        if (schema.AdditionalProperties is not null)
        {
            _schemasWithReference.AddOrUpdate(schema.AdditionalProperties, (_) => null, (_, _) => Guid.NewGuid().ToString());
        }
        if (schema.Items is not null)
        {
            _schemasWithReference.AddOrUpdate(schema.Items, (_) => null, (_, _) => Guid.NewGuid().ToString());
        }
        if (schema.AllOf is not null)
        {
            foreach (var allOfSchema in schema.AllOf)
            {
                _schemasWithReference.AddOrUpdate(allOfSchema, (_) => null, (_, _) => Guid.NewGuid().ToString());
            }
        }
        if (schema.Properties is not null)
        {
            foreach (var property in schema.Properties.Values)
            {
                _schemasWithReference.AddOrUpdate(property, (_) => null, (_, _) => Guid.NewGuid().ToString());
            }
        }
    }

    public ConcurrentDictionary<OpenApiSchema, string?> SchemasByReference => _schemasWithReference;
}
